name: Build Packages

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: lahiru98s/openwrt-build:debian
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download SDK
      run: |
        wget -O sdk.tar.zst https://downloads.openwrt.org/releases/24.10.5/targets/qualcommax/ipq807x/openwrt-sdk-24.10.5-qualcommax-ipq807x_gcc-13.3.0_musl.Linux-x86_64.tar.zst

    - name: Extract SDK
      run: |
        tar -I zstd -xf sdk.tar.zst
        mv openwrt-sdk-24.10.5-qualcommax-ipq807x_gcc-13.3.0_musl.Linux-x86_64 sdk

    - name: Setup custom packages
      run: |
        cd sdk
        echo "src-link custom $GITHUB_WORKSPACE" >> feeds.conf.default
        ./scripts/feeds update custom
        ./scripts/feeds install -a -p custom
        make defconfig

    - name: Build packages
      run: |
        cd sdk
        grep -v '^#' $GITHUB_WORKSPACE/build-packages.conf | grep -v '^$' | while read -r pkg; do
          echo "Building package: $pkg"
          make package/$pkg/compile V=s || echo "Failed to build $pkg"
        done