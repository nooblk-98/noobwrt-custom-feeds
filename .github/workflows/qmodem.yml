name: Sync Upstream QModem Repository

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    # Allow manual trigger from GitHub UI

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout current repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --global core.safecrlf false
          git config --global core.autocrlf false
          echo "Git configured to handle line endings"

      - name: Clone upstream repository
        run: |
          mkdir -p packages
          
          echo "Cloning QModem repository..."
          git clone https://github.com/FUjr/QModem.git temp_qmodem
          
          # Check if luci folder exists in the cloned repo
          if [ -d "temp_qmodem/luci" ]; then
            echo "QModem luci folder found, syncing contents..."
            
            # Copy all subdirectories from luci folder to packages
            for dir in temp_qmodem/luci/*/; do
              if [ -d "$dir" ]; then
                dir_name=$(basename "$dir")
                echo "Syncing: $dir_name"
                mkdir -p "packages/$dir_name"
                cp -r "$dir"* "packages/$dir_name/" || cp -r "$dir" "packages/" || true
              fi
            done
            
            # Also copy any files directly in luci folder
            cp -r temp_qmodem/luci/*.* packages/ 2>/dev/null || true
            
            echo "Luci folder sync completed"
          else
            echo "ERROR: luci folder not found in QModem repository"
            ls -la temp_qmodem/
            exit 1
          fi
          
          # Clean up temporary folder
          rm -rf temp_qmodem
          
          echo "Final packages folder contents:"
          ls -la packages/

      - name: Check for changes
        id: check_changes
        run: |
          if [ -d "packages" ] && [ "$(ls -A packages/)" ]; then
            echo "Luci packages synced successfully"
            echo "Packages folder contents:"
            ls -la packages/
          else
            echo "Failed to sync luci packages"
            exit 1
          fi

      - name: Clean up temporary files
        run: |
          # Remove any remaining temp folders
          rm -rf temp_qmodem
          echo "Cleanup completed"
          echo "Final packages contents:"
          ls -la packages/ | head -20

      - name: Check for differences
        id: diff
        run: |
          # Check if there are any changes in packages folder
          if git diff --quiet packages/; then
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected in packages/QModem"
          else
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected in packages/QModem"
            git diff --stat packages/ || true
          fi

      - name: Commit and push changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config core.safecrlf false
          git config core.autocrlf false
          
          # Force add all files in packages folder
          git add -A packages/
          
          # Check git status
          echo "Git status:"
          git status
          
          # Count staged files
          staged_files=$(git diff --cached --name-only | wc -l)
          echo "Staged files: $staged_files"
          
          # Commit and push if there are changes
          if [ $staged_files -gt 0 ]; then
            echo "Committing $staged_files files..."
            git commit -m "chore: sync QModem repository from upstream"
            git push origin HEAD:main
            echo "Changes pushed successfully"
          else
            echo "No changes to commit"
          fi
