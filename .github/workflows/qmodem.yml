name: Sync Upstream QModem Repository

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    # Allow manual trigger from GitHub UI

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout current repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Clone upstream repository
        run: |
          mkdir -p packages
          
          if [ -d "packages/QModem" ]; then
            echo "QModem folder already exists, updating..."
            cd packages/QModem
            git pull origin main || git pull origin master || true
            cd ../..
          else
            echo "QModem folder not found, cloning..."
            git clone https://github.com/FUjr/QModem.git packages/QModem
          fi
          
          echo "Repository sync completed"
          echo "Contents of QModem folder:"
          ls -la packages/QModem/

      - name: Check for changes
        id: check_changes
        run: |
          if [ -d "packages/QModem" ]; then
            echo "QModem repository synced successfully"
            echo "Contents of QModem:"
            ls -la packages/QModem/
          else
            echo "Failed to sync QModem repository"
            exit 1
          fi

      - name: Clean up temporary files
        run: |
          # Remove .git folder from cloned repo to avoid nested git
          rm -rf packages/QModem/.git
          echo "Removed .git folder from QModem clone"
          echo "QModem folder contents:"
          ls -la packages/QModem/ | head -20

      - name: Check for differences
        id: diff
        run: |
          # Check if there are any changes in packages folder
          if git diff --quiet packages/; then
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected in packages/QModem"
          else
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected in packages/QModem"
            git diff --stat packages/ || true
          fi

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Force add all files in packages folder
          git add -A packages/
          
          # Check git status
          echo "Git status:"
          git status
          
          # Commit and push if there are changes
          if ! git diff --cached --quiet; then
            echo "Changes detected, committing..."
            git commit -m "chore: sync QModem repository from upstream"
            git push
            echo "Changes pushed successfully"
          else
            echo "No changes to commit"
          fi
